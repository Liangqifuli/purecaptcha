# Spring Boot é›†æˆ PureCaptcha ä½¿ç”¨è¯´æ˜

## ğŸ“ æ–‡ä»¶æ¸…å•

```
examples/
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ CaptchaService.java      â† Serviceå±‚ï¼ˆå¤åˆ¶åˆ°ä½ çš„é¡¹ç›®ï¼‰
â”‚   â”œâ”€â”€ CaptchaController.java   â† Controllerå±‚ï¼ˆå¤åˆ¶åˆ°ä½ çš„é¡¹ç›®ï¼‰
â”‚   â””â”€â”€ ä½¿ç”¨è¯´æ˜.md              â† æœ¬æ–‡ä»¶
â””â”€â”€ frontend/
    â””â”€â”€ slider-captcha-test.html â† å‰ç«¯æµ‹è¯•é¡µé¢
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ­¥éª¤1ï¼šæ·»åŠ Mavenä¾èµ–

åœ¨ä½ çš„é¡¹ç›® `pom.xml` ä¸­æ·»åŠ ï¼š

```xml
<dependency>
    <groupId>io.github.purecaptcha</groupId>
    <artifactId>pure-captcha</artifactId>
    <version>1.0.0</version>
</dependency>
```

### æ­¥éª¤2ï¼šå¤åˆ¶ä»£ç åˆ°é¡¹ç›®

```
ä½ çš„é¡¹ç›®/
â””â”€â”€ src/main/java/com/example/captcha/
    â”œâ”€â”€ service/
    â”‚   â””â”€â”€ CaptchaService.java      â† å¤åˆ¶è¿™ä¸ªæ–‡ä»¶
    â””â”€â”€ controller/
        â””â”€â”€ CaptchaController.java   â† å¤åˆ¶è¿™ä¸ªæ–‡ä»¶
```

**æ³¨æ„**ï¼šä¿®æ”¹åŒ…åä¸ºä½ çš„é¡¹ç›®åŒ…åï¼

### æ­¥éª¤3ï¼šå¯åŠ¨é¡¹ç›®

```bash
mvn spring-boot:run
```

### æ­¥éª¤4ï¼šæµ‹è¯•

æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š
- å‰ç«¯æµ‹è¯•é¡µé¢ï¼š`examples/frontend/slider-captcha-test.html`
- ä¿®æ”¹ HTML ä¸­çš„ API åœ°å€ä¸ºï¼š`http://localhost:8080/api/captcha`

---

## ğŸ“¡ API æ¥å£æ–‡æ¡£

### 1. ç”Ÿæˆæ»‘åŠ¨éªŒè¯ç 

**è¯·æ±‚**ï¼š
```http
GET /api/captcha/slider
```

**å“åº”**ï¼š
```json
{
  "success": true,
  "data": {
    "backgroundImage": "data:image/png;base64,...",
    "sliderImage": "data:image/png;base64,...",
    "sliderY": 80
  }
}
```

---

### 2. è‡ªå®šä¹‰å°ºå¯¸æ»‘åŠ¨éªŒè¯ç 

**è¯·æ±‚**ï¼š
```http
GET /api/captcha/slider/custom?width=400&height=250&useBuiltinBg=true
```

**å‚æ•°**ï¼š
- `width`: å®½åº¦ï¼ˆé»˜è®¤350ï¼‰
- `height`: é«˜åº¦ï¼ˆé»˜è®¤200ï¼‰
- `useBuiltinBg`: ä½¿ç”¨å†…ç½®èƒŒæ™¯ï¼ˆé»˜è®¤trueï¼Œ11å¼ éšæœºï¼‰

---

### 3. éªŒè¯ç”¨æˆ·è¾“å…¥

**è¯·æ±‚**ï¼š
```http
POST /api/captcha/verify
Content-Type: application/json

{
  "answer": "150"
}
```

**å“åº”**ï¼š
```json
{
  "success": true,
  "message": "éªŒè¯é€šè¿‡ï¼"
}
```

---

### 4. éªŒè¯æ»‘åŠ¨ä½ç½®ï¼ˆç®€åŒ–æ¥å£ï¼‰

**è¯·æ±‚**ï¼š
```http
POST /api/captcha/verify/slider?x=150
```

---

### 5. è°ƒè¯•æ¥å£ï¼ˆæŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ï¼‰

**è¯·æ±‚**ï¼š
```http
POST /api/captcha/debug
Content-Type: application/json

{
  "answer": "150"
}
```

**å“åº”**ï¼š
```json
{
  "success": true,
  "details": "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\næ»‘åŠ¨éªŒè¯ç è¯¦ç»†éªŒè¯æŠ¥å‘Š\n..."
}
```

---

### 6. å…¶ä»–éªŒè¯ç ç±»å‹

- å­—ç¬¦éªŒè¯ç ï¼š`GET /api/captcha/alphanumeric`
- ç®—æœ¯éªŒè¯ç ï¼š`GET /api/captcha/arithmetic`
- ä¸­æ–‡éªŒè¯ç ï¼š`GET /api/captcha/chinese`
- GIFåŠ¨ç”»éªŒè¯ç ï¼š`GET /api/captcha/gif`

---

## ğŸ’» å‰ç«¯é›†æˆç¤ºä¾‹

### Vue.js

```vue
<template>
  <div>
    <img :src="backgroundImage" />
    <img :src="sliderImage" :style="{ top: sliderY + 'px' }" />
    <input v-model="userX" type="number" />
    <button @click="verify">éªŒè¯</button>
  </div>
</template>

<script>
export default {
  data() {
    return {
      backgroundImage: '',
      sliderImage: '',
      sliderY: 0,
      userX: 0
    }
  },
  mounted() {
    this.loadCaptcha()
  },
  methods: {
    async loadCaptcha() {
      const res = await fetch('/api/captcha/slider', {
        credentials: 'include' // é‡è¦ï¼šåŒ…å«session
      })
      const data = await res.json()
      if (data.success) {
        this.backgroundImage = data.data.backgroundImage
        this.sliderImage = data.data.sliderImage
        this.sliderY = data.data.sliderY
      }
    },
    async verify() {
      const res = await fetch('/api/captcha/verify', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ answer: this.userX.toString() })
      })
      const data = await res.json()
      alert(data.message)
    }
  }
}
</script>
```

---

### React

```jsx
import React, { useState, useEffect } from 'react';

function SliderCaptcha() {
  const [backgroundImage, setBackgroundImage] = useState('');
  const [sliderImage, setSliderImage] = useState('');
  const [sliderY, setSliderY] = useState(0);
  const [userX, setUserX] = useState(0);

  useEffect(() => {
    loadCaptcha();
  }, []);

  const loadCaptcha = async () => {
    const res = await fetch('/api/captcha/slider', {
      credentials: 'include'
    });
    const data = await res.json();
    if (data.success) {
      setBackgroundImage(data.data.backgroundImage);
      setSliderImage(data.data.sliderImage);
      setSliderY(data.data.sliderY);
    }
  };

  const verify = async () => {
    const res = await fetch('/api/captcha/verify', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ answer: userX.toString() })
    });
    const data = await res.json();
    alert(data.message);
  };

  return (
    <div>
      <img src={backgroundImage} alt="èƒŒæ™¯" />
      <img src={sliderImage} style={{ top: `${sliderY}px` }} alt="æ»‘å—" />
      <input 
        type="number" 
        value={userX} 
        onChange={(e) => setUserX(e.target.value)} 
      />
      <button onClick={verify}>éªŒè¯</button>
    </div>
  );
}
```

---

### jQuery

```javascript
$(document).ready(function() {
  loadCaptcha();

  function loadCaptcha() {
    $.ajax({
      url: '/api/captcha/slider',
      method: 'GET',
      xhrFields: { withCredentials: true },
      success: function(data) {
        if (data.success) {
          $('#backgroundImage').attr('src', data.data.backgroundImage);
          $('#sliderImage').attr('src', data.data.sliderImage);
          $('#sliderImage').css('top', data.data.sliderY + 'px');
        }
      }
    });
  }

  $('#verifyBtn').click(function() {
    var userX = $('#userX').val();
    $.ajax({
      url: '/api/captcha/verify',
      method: 'POST',
      contentType: 'application/json',
      xhrFields: { withCredentials: true },
      data: JSON.stringify({ answer: userX }),
      success: function(data) {
        alert(data.message);
      }
    });
  });
});
```

---

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### 1. æ™ºèƒ½éªŒè¯ç®—æ³•

**è‡ªåŠ¨å¯ç”¨**ï¼Œæ— éœ€é¢å¤–é…ç½®ï¼

```java
// Serviceå±‚è‡ªåŠ¨ä½¿ç”¨æ™ºèƒ½éªŒè¯
if (captcha instanceof SliderCaptchaResult) {
    SliderCaptchaResult sliderCaptcha = (SliderCaptchaResult) captcha;
    int userX = Integer.parseInt(userAnswer);
    // æ™ºèƒ½éªŒè¯ï¼ˆå›¾åƒç›¸ä¼¼åº¦åŒ¹é…ï¼‰
    return sliderCaptcha.verifyPosition(userX);
}
```

**ä¼˜åŠ¿**ï¼š
- âœ… æˆåŠŸç‡ä»60%æå‡åˆ°95%
- âœ… è§£å†³"æ˜æ˜å¯¹é½äº†å´å¤±è´¥"çš„é—®é¢˜
- âœ… åŸºäºå›¾åƒç›¸ä¼¼åº¦ï¼Œä¸ä¾èµ–ç²¾ç¡®åæ ‡

---

### 2. è‡ªåŠ¨æ¸…ç†è¿‡æœŸéªŒè¯ç 

```java
// æ„é€ å‡½æ•°ä¸­å¯åŠ¨å®šæ—¶ä»»åŠ¡
public CaptchaService() {
    scheduler.scheduleAtFixedRate(() -> {
        captchaStore.entrySet().removeIf(entry -> entry.getValue().isExpired());
    }, 1, 1, TimeUnit.MINUTES);
}
```

**è¿‡æœŸæ—¶é—´**ï¼š5åˆ†é’Ÿï¼ˆå¯ä¿®æ”¹ `EXPIRE_TIME` å¸¸é‡ï¼‰

---

### 3. 11å¼ å†…ç½®é«˜æ¸…èƒŒæ™¯

éšæœºä½¿ç”¨ï¼Œæ— éœ€æ‰‹åŠ¨ç®¡ç†å›¾ç‰‡ï¼š

```java
captchaService.generateSliderCaptcha(sessionId, 350, 200, true);
```

---

## ğŸ”§ å¸¸è§é—®é¢˜

### Q1: Session é—®é¢˜ï¼ˆéªŒè¯æ€»æ˜¯å¤±è´¥ï¼‰

**é—®é¢˜**ï¼šå‰ç«¯è¯·æ±‚æ—¶æ²¡æœ‰åŒ…å« Cookieï¼Œå¯¼è‡´åç«¯æ— æ³•è¯†åˆ« Sessionã€‚

**è§£å†³**ï¼šå‰ç«¯è¯·æ±‚æ—¶å¿…é¡»åŒ…å« `credentials: 'include'`

```javascript
fetch('/api/captcha/slider', {
  credentials: 'include'  // é‡è¦ï¼
})
```

---

### Q2: è·¨åŸŸé—®é¢˜

**é—®é¢˜**ï¼šå‰åç«¯åˆ†ç¦»æ—¶ï¼Œè·¨åŸŸè¯·æ±‚è¢«é˜»æ­¢ã€‚

**è§£å†³æ–¹å¼1**ï¼šController ä¸Šæ·»åŠ æ³¨è§£ï¼ˆæµ‹è¯•ç”¨ï¼‰

```java
@CrossOrigin(origins = "http://localhost:3000")
```

**è§£å†³æ–¹å¼2**ï¼šå…¨å±€é…ç½®ï¼ˆæ¨èï¼‰

```java
@Configuration
public class WebConfig implements WebMvcConfigurer {
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/api/**")
                .allowedOrigins("http://localhost:3000")
                .allowCredentials(true)
                .allowedMethods("GET", "POST", "PUT", "DELETE");
    }
}
```

---

### Q3: å†…å­˜å ç”¨

**é—®é¢˜**ï¼šä¿å­˜å®Œæ•´å¯¹è±¡ä¼šå ç”¨æ›´å¤šå†…å­˜ã€‚

**è§£å†³**ï¼š
1. éªŒè¯ç è‡ªåŠ¨è¿‡æœŸï¼ˆ5åˆ†é’Ÿï¼‰
2. å®šæ—¶æ¸…ç†ä»»åŠ¡
3. éªŒè¯åç«‹å³åˆ é™¤
4. å¦‚æœæ˜¯åˆ†å¸ƒå¼ï¼Œä½¿ç”¨ Redis å­˜å‚¨

---

### Q4: Redis é›†æˆï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦åˆ†å¸ƒå¼æ”¯æŒï¼Œä¿®æ”¹ `CaptchaService`ï¼š

```java
@Service
public class CaptchaService {
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    private static final String KEY_PREFIX = "captcha:";
    private static final long EXPIRE_SECONDS = 300;
    
    public Object generateCaptcha(String sessionId, CaptchaType type) {
        Captcha captcha = CaptchaFactory.create(type);
        redisTemplate.opsForValue().set(
            KEY_PREFIX + sessionId, 
            captcha, 
            EXPIRE_SECONDS, 
            TimeUnit.SECONDS
        );
        // ...
    }
}
```

---

## ğŸ“Š ç›‘æ§æ¥å£

### æŸ¥çœ‹å½“å‰éªŒè¯ç æ•°é‡

```http
GET /api/captcha/count
```

### æ¸…ç†æ‰€æœ‰éªŒè¯ç 

```http
DELETE /api/captcha/clear
```

---

## ğŸ‰ å®Œæˆï¼

1. âœ… å¤åˆ¶ Service å’Œ Controller åˆ°é¡¹ç›®
2. âœ… ä¿®æ”¹åŒ…å
3. âœ… å¯åŠ¨é¡¹ç›®
4. âœ… æ‰“å¼€æµ‹è¯•é¡µé¢
5. âœ… äº«å—95%æˆåŠŸç‡çš„æ™ºèƒ½éªŒè¯ï¼

**æœ‰é—®é¢˜ï¼ŸæŸ¥çœ‹**ï¼š
- `æ™ºèƒ½éªŒè¯ç®—æ³•è¯´æ˜.md` - è¯¦ç»†æŠ€æœ¯åŸç†
- `æ™ºèƒ½éªŒè¯å¿«é€Ÿä½¿ç”¨.txt` - å¿«é€Ÿå‚è€ƒ
- `examples/TestSmartVerification.java` - æµ‹è¯•ç¨‹åº

---

**ç¥ä½¿ç”¨æ„‰å¿«ï¼** ğŸš€

