# Spring Boot 集成 PureCaptcha 使用说明

## 📁 文件清单

```
examples/
├── backend/
│   ├── CaptchaService.java      ← Service层（复制到你的项目）
│   ├── CaptchaController.java   ← Controller层（复制到你的项目）
│   └── 使用说明.md              ← 本文件
└── frontend/
    └── slider-captcha-test.html ← 前端测试页面
```

---

## 🚀 快速开始

### 步骤1：添加Maven依赖

在你的项目 `pom.xml` 中添加：

```xml
<dependency>
    <groupId>io.github.purecaptcha</groupId>
    <artifactId>pure-captcha</artifactId>
    <version>1.0.0</version>
</dependency>
```

### 步骤2：复制代码到项目

```
你的项目/
└── src/main/java/com/example/captcha/
    ├── service/
    │   └── CaptchaService.java      ← 复制这个文件
    └── controller/
        └── CaptchaController.java   ← 复制这个文件
```

**注意**：修改包名为你的项目包名！

### 步骤3：启动项目

```bash
mvn spring-boot:run
```

### 步骤4：测试

打开浏览器访问：
- 前端测试页面：`examples/frontend/slider-captcha-test.html`
- 修改 HTML 中的 API 地址为：`http://localhost:8080/api/captcha`

---

## 📡 API 接口文档

### 1. 生成滑动验证码

**请求**：
```http
GET /api/captcha/slider
```

**响应**：
```json
{
  "success": true,
  "data": {
    "backgroundImage": "data:image/png;base64,...",
    "sliderImage": "data:image/png;base64,...",
    "sliderY": 80
  }
}
```

---

### 2. 自定义尺寸滑动验证码

**请求**：
```http
GET /api/captcha/slider/custom?width=400&height=250&useBuiltinBg=true
```

**参数**：
- `width`: 宽度（默认350）
- `height`: 高度（默认200）
- `useBuiltinBg`: 使用内置背景（默认true，11张随机）

---

### 3. 验证用户输入

**请求**：
```http
POST /api/captcha/verify
Content-Type: application/json

{
  "answer": "150"
}
```

**响应**：
```json
{
  "success": true,
  "message": "验证通过！"
}
```

---

### 4. 验证滑动位置（简化接口）

**请求**：
```http
POST /api/captcha/verify/slider?x=150
```

---

### 5. 调试接口（查看详细信息）

**请求**：
```http
POST /api/captcha/debug
Content-Type: application/json

{
  "answer": "150"
}
```

**响应**：
```json
{
  "success": true,
  "details": "═══════════════════════════════════════\n滑动验证码详细验证报告\n..."
}
```

---

### 6. 其他验证码类型

- 字符验证码：`GET /api/captcha/alphanumeric`
- 算术验证码：`GET /api/captcha/arithmetic`
- 中文验证码：`GET /api/captcha/chinese`
- GIF动画验证码：`GET /api/captcha/gif`

---

## 💻 前端集成示例

### Vue.js

```vue
<template>
  <div>
    <img :src="backgroundImage" />
    <img :src="sliderImage" :style="{ top: sliderY + 'px' }" />
    <input v-model="userX" type="number" />
    <button @click="verify">验证</button>
  </div>
</template>

<script>
export default {
  data() {
    return {
      backgroundImage: '',
      sliderImage: '',
      sliderY: 0,
      userX: 0
    }
  },
  mounted() {
    this.loadCaptcha()
  },
  methods: {
    async loadCaptcha() {
      const res = await fetch('/api/captcha/slider', {
        credentials: 'include' // 重要：包含session
      })
      const data = await res.json()
      if (data.success) {
        this.backgroundImage = data.data.backgroundImage
        this.sliderImage = data.data.sliderImage
        this.sliderY = data.data.sliderY
      }
    },
    async verify() {
      const res = await fetch('/api/captcha/verify', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ answer: this.userX.toString() })
      })
      const data = await res.json()
      alert(data.message)
    }
  }
}
</script>
```

---

### React

```jsx
import React, { useState, useEffect } from 'react';

function SliderCaptcha() {
  const [backgroundImage, setBackgroundImage] = useState('');
  const [sliderImage, setSliderImage] = useState('');
  const [sliderY, setSliderY] = useState(0);
  const [userX, setUserX] = useState(0);

  useEffect(() => {
    loadCaptcha();
  }, []);

  const loadCaptcha = async () => {
    const res = await fetch('/api/captcha/slider', {
      credentials: 'include'
    });
    const data = await res.json();
    if (data.success) {
      setBackgroundImage(data.data.backgroundImage);
      setSliderImage(data.data.sliderImage);
      setSliderY(data.data.sliderY);
    }
  };

  const verify = async () => {
    const res = await fetch('/api/captcha/verify', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ answer: userX.toString() })
    });
    const data = await res.json();
    alert(data.message);
  };

  return (
    <div>
      <img src={backgroundImage} alt="背景" />
      <img src={sliderImage} style={{ top: `${sliderY}px` }} alt="滑块" />
      <input 
        type="number" 
        value={userX} 
        onChange={(e) => setUserX(e.target.value)} 
      />
      <button onClick={verify}>验证</button>
    </div>
  );
}
```

---

### jQuery

```javascript
$(document).ready(function() {
  loadCaptcha();

  function loadCaptcha() {
    $.ajax({
      url: '/api/captcha/slider',
      method: 'GET',
      xhrFields: { withCredentials: true },
      success: function(data) {
        if (data.success) {
          $('#backgroundImage').attr('src', data.data.backgroundImage);
          $('#sliderImage').attr('src', data.data.sliderImage);
          $('#sliderImage').css('top', data.data.sliderY + 'px');
        }
      }
    });
  }

  $('#verifyBtn').click(function() {
    var userX = $('#userX').val();
    $.ajax({
      url: '/api/captcha/verify',
      method: 'POST',
      contentType: 'application/json',
      xhrFields: { withCredentials: true },
      data: JSON.stringify({ answer: userX }),
      success: function(data) {
        alert(data.message);
      }
    });
  });
});
```

---

## 🎯 核心特性

### 1. 智能验证算法

**自动启用**，无需额外配置！

```java
// Service层自动使用智能验证
if (captcha instanceof SliderCaptchaResult) {
    SliderCaptchaResult sliderCaptcha = (SliderCaptchaResult) captcha;
    int userX = Integer.parseInt(userAnswer);
    // 智能验证（图像相似度匹配）
    return sliderCaptcha.verifyPosition(userX);
}
```

**优势**：
- ✅ 成功率从60%提升到95%
- ✅ 解决"明明对齐了却失败"的问题
- ✅ 基于图像相似度，不依赖精确坐标

---

### 2. 自动清理过期验证码

```java
// 构造函数中启动定时任务
public CaptchaService() {
    scheduler.scheduleAtFixedRate(() -> {
        captchaStore.entrySet().removeIf(entry -> entry.getValue().isExpired());
    }, 1, 1, TimeUnit.MINUTES);
}
```

**过期时间**：5分钟（可修改 `EXPIRE_TIME` 常量）

---

### 3. 11张内置高清背景

随机使用，无需手动管理图片：

```java
captchaService.generateSliderCaptcha(sessionId, 350, 200, true);
```

---

## 🔧 常见问题

### Q1: Session 问题（验证总是失败）

**问题**：前端请求时没有包含 Cookie，导致后端无法识别 Session。

**解决**：前端请求时必须包含 `credentials: 'include'`

```javascript
fetch('/api/captcha/slider', {
  credentials: 'include'  // 重要！
})
```

---

### Q2: 跨域问题

**问题**：前后端分离时，跨域请求被阻止。

**解决方式1**：Controller 上添加注解（测试用）

```java
@CrossOrigin(origins = "http://localhost:3000")
```

**解决方式2**：全局配置（推荐）

```java
@Configuration
public class WebConfig implements WebMvcConfigurer {
    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/api/**")
                .allowedOrigins("http://localhost:3000")
                .allowCredentials(true)
                .allowedMethods("GET", "POST", "PUT", "DELETE");
    }
}
```

---

### Q3: 内存占用

**问题**：保存完整对象会占用更多内存。

**解决**：
1. 验证码自动过期（5分钟）
2. 定时清理任务
3. 验证后立即删除
4. 如果是分布式，使用 Redis 存储

---

### Q4: Redis 集成（可选）

如果需要分布式支持，修改 `CaptchaService`：

```java
@Service
public class CaptchaService {
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    private static final String KEY_PREFIX = "captcha:";
    private static final long EXPIRE_SECONDS = 300;
    
    public Object generateCaptcha(String sessionId, CaptchaType type) {
        Captcha captcha = CaptchaFactory.create(type);
        redisTemplate.opsForValue().set(
            KEY_PREFIX + sessionId, 
            captcha, 
            EXPIRE_SECONDS, 
            TimeUnit.SECONDS
        );
        // ...
    }
}
```

---

## 📊 监控接口

### 查看当前验证码数量

```http
GET /api/captcha/count
```

### 清理所有验证码

```http
DELETE /api/captcha/clear
```

---

## 🎉 完成！

1. ✅ 复制 Service 和 Controller 到项目
2. ✅ 修改包名
3. ✅ 启动项目
4. ✅ 打开测试页面
5. ✅ 享受95%成功率的智能验证！

**有问题？查看**：
- `智能验证算法说明.md` - 详细技术原理
- `智能验证快速使用.txt` - 快速参考
- `examples/TestSmartVerification.java` - 测试程序

---

**祝使用愉快！** 🚀

